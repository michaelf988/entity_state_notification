blueprint:
  name: "üí¨ Zustandsbenachrichtigung (Blueprint v1.4)"
  description: >
    Benachrichtigt dich, wenn ausgew√§hlte Entit√§ten einen Zielzustand erreichen
    (oder numerisch dar√ºber/darunter liegen). Optional periodische Wiederholung,
    Aktionen und Bedingungen.
  source_url: https://github.com/michaelf988/entity_state_notification/blob/main/entity_state_notification.yaml
  domain: automation

  input:
    sensor_section:
      name: Entit√§ten / Gleichheitsvergleich
      icon: mdi:equal-box
      collapsed: true
      input:
        input_entities:
          name: "üñ≤Ô∏è Beobachtete Entit√§ten"
          description: >
            Entit√§ten, die die Benachrichtigung ausl√∂sen.
          default: []
          selector:
            entity:
              multiple: true

        input_entity_states:
          name: "üü¢ Zielzust√§nde"
          description: >
            Zust√§nde, die die Automatisierung ausl√∂sen.
          default: []
          selector:
            text:
              multiple: true

        input_entity_state_duration:
          name: "‚è≤Ô∏è Verweilzeit im Zielzustand"
          description: >
            Dauer, die die Entit√§t im Zielzustand sein muss.
          default:
            hours: 0
            minutes: 0
            seconds: 2
          selector:
            duration:

    # Mehrere "normale" Zust√§nde (indexbasiert)
    state_multi_section:
      name: Mehrere Zust√§nde (indexbasiert)
      icon: mdi:format-list-bulleted
      collapsed: true
      input:
        ms_entities:
          name: "üñ≤Ô∏è Entit√§ten (Mehrfach)"
          description: >
            Liste der zu √ºberwachenden Entit√§ten. Die Position entspricht den
            Zielzust√§nden in der n√§chsten Liste.
          default: []
          selector:
            entity:
              multiple: true

        ms_target_states:
          name: "üü¢ Zielzust√§nde je Entit√§t"
          description: >
            F√ºr jede Entit√§t ein Eintrag. Mehrere Zust√§nde pro Eintrag mit | oder , trennen
            (z. B. "on|open", "home,available").
          default: []
          selector:
            text:
              multiple: true

    # Mehrere numerische Vergleiche (indexbasiert, Operator im Feld)
    numeric_multi_section:
      name: Mehrere numerische Vergleiche (indexbasiert)
      icon: mdi:view-list
      collapsed: true
      input:
        nm_entities:
          name: "üñ≤Ô∏è Numerische Entit√§ten (Mehrfach)"
          description: >
            Liste der zu √ºberwachenden numerischen Entit√§ten. Die Position
            entspricht dem passenden Schwellwert unten.
          default: []
          selector:
            entity:
              multiple: true

        nm_thresholds:
          name: "üü¢ Schwellwerte je Entit√§t (mit Operator)"
          description: >
            Pro Entit√§t genau ein Eintrag mit Operator **<** oder **>** und Zahl.
            Beispiele: `>5`, `<1,2`, `> 12.3`. Dezimal-Komma wird unterst√ºtzt.
          default: []
          selector:
            text:
              multiple: true

        input_numeric_entity_state_duration:
          name: "‚è≤Ô∏è Verweilzeit (Multi-Numerik)"
          description: >
            Dauer, die die Bedingung (> oder <) ununterbrochen erf√ºllt sein muss,
            bevor benachrichtigt wird. 0 = sofort.
          default:
            hours: 0
            minutes: 0
            seconds: 2
          selector:
            duration:

    notifcation_section:
      name: Benachrichtigung
      icon: mdi:chat
      collapsed: true
      input:
        input_notify_devices:
          name: "üì± Ger√§t(e) benachrichtigen"
          description: >
            Ger√§te/Gruppen, die die Benachrichtigung erhalten.
          default: []
          selector:
            device:
              multiple: true
              filter:
                integration: mobile_app

        input_notify_groups:
          name: "ü´Ç Benachrichtigungsgruppen"
          description: >
            Namen von Notification-Gruppen (notify.Gruppenname).
          default: []
          selector:
            text:
              multiple: true

        input_title:
          name: "üìï Titel"
          description: >
            Titel der Benachrichtigung.
          default: "{{ entity_name }} ist {{ new_state }}"

        input_message:
          name: "üí¨ Nachricht"
          description: >
            Text der Benachrichtigung.
          default: "Hinweis: {{ entity_name }} ist {{ new_state }}"

        input_persistent_notification:
          name: "ü™® Persistente Benachrichtigung"
          description: >
            Kann nicht weggewischt werden; verschwindet erst,
            wenn die Entit√§t den Zielzustand verl√§sst.
          default: false
          selector:
            boolean:

        input_notification_auto_delete:
          name: "‚ùå Auto-Schlie√üen"
          description: >
            Benachrichtigungen automatisch schlie√üen,
            wenn die Zielzustands-Bedingung nicht mehr gilt.
          default: true
          selector:
            boolean:

        input_ha_notification:
          name: "üè† HA-Benachrichtigung (Frontend)"
          description: >
            Erstellt zus√§tzlich eine persistente Benachrichtigung im HA-Frontend.
          default: false
          selector:
            boolean:

        # iOS / allgemeine Felder
        input_interruption_level:
          name: "‚õî Interruption Level (iOS)"
          description: >
            Einstellen, wie ‚Äûdringlich‚Äú die Benachrichtigung ist.
          default: "active"
          selector:
            select:
              options:
                - passive
                - active
                - time-sensitive
                - critical

        input_custom_tag:
          name: "üè∑Ô∏è Tag"
          description: >
            Tag f√ºr die Benachrichtigung (zur sp√§teren Identifikation).
            Leer lassen, um einen Tag automatisch zu generieren.
          default: ""
          selector:
            text:

        input_ios_sound:
          name: "üîä iOS Sound"
          description: >
            Name des Sounds (z. B. default oder <Soundname>).
          default: "default"
          selector:
            text:

        input_critical_volume:
          name: "üîä Kritische Lautst√§rke (iOS)"
          description: >
            Nur bei *Interruption Level* = **critical**. Bereich 0.0‚Äì1.0 (0‚Äì100 %).
          default: 1.0
          selector:
            number:
              min: 0
              max: 1
              step: 0.05

        input_group_text:
          name: "üìë Group"
          description: >
            Gruppiere Benachrichtigungen √ºber diese Kennung.
          default: ""
          selector:
            text:

    actionable_section:
      name: Actionable Notifications
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        input_action_timeout:
          name: "‚è≥ Antwort-Timeout"
          description: >
            Wartezeit auf eine Antwort-Aktion.
          default:
            hours: 0
            minutes: 0
            seconds: 60
          selector:
            duration:

        # Action 1
        input_action1_enabled:
          name: "Aktion 1 aktivieren"
          default: false
          selector:
            boolean:
        input_action1_title:
          name: "Titel Aktion 1"
          default: "Aktion 1"
          selector:
            text:
        input_action1_type:
          name: "Typ Aktion 1"
          default: "uri"
          selector:
            select:
              options:
                - uri
                - ha_action
        input_action1_uri:
          name: "URI Aktion 1 (falls Typ=uri)"
          default: ""
          selector:
            text:
        input_action1_destructive:
          name: "Destructive (Aktion 1)"
          default: false
          selector:
            boolean:
        input_action1_ha_action:
          name: "HA-Aktion bei Antwort (Aktion 1, falls Typ=ha_action)"
          default: []
          selector:
            action: {}

        # Action 2
        input_action2_enabled:
          name: "Aktion 2 aktivieren"
          default: false
          selector:
            boolean:
        input_action2_title:
          name: "Titel Aktion 2"
          default: "Aktion 2"
          selector:
            text:
        input_action2_type:
          name: "Typ Aktion 2"
          default: "uri"
          selector:
            select:
              options:
                - uri
                - ha_action
        input_action2_uri:
          name: "URI Aktion 2 (falls Typ=uri)"
          default: ""
          selector:
            text:
        input_action2_destructive:
          name: "Destructive (Aktion 2)"
          default: false
          selector:
            boolean:
        input_action2_ha_action:
          name: "HA-Aktion bei Antwort (Aktion 2, falls Typ=ha_action)"
          default: []
          selector:
            action: {}

        # Action 3
        input_action3_enabled:
          name: "Aktion 3 aktivieren"
          default: false
          selector:
            boolean:
        input_action3_title:
          name: "Titel Aktion 3"
          default: "Aktion 3"
          selector:
            text:
        input_action3_type:
          name: "Typ Aktion 3"
          default: "uri"
          selector:
            select:
              options:
                - uri
                - ha_action
        input_action3_uri:
          name: "URI Aktion 3 (falls Typ=uri)"
          default: ""
          selector:
            text:
        input_action3_destructive:
          name: "Destructive (Aktion 3)"
          default: false
          selector:
            boolean:
        input_action3_ha_action:
          name: "HA-Aktion bei Antwort (Aktion 3, falls Typ=ha_action)"
          default: []
          selector:
            action: {}

    peridodic_notification_section:
      name: Periodische Benachrichtigungen
      icon: mdi:refresh
      collapsed: true
      input:
        input_period:
          name: "üîÑ Wiederholung"
          description: >
            Sendet periodisch Benachrichtigungen (0 = aus).
          default:
            hours: 0
            minutes: 0
            seconds: 0
          selector:
            duration:

        input_stop_button_text:
          name: "üí¨ Stopp-Button-Text"
          description: >
            Text f√ºr den Button, der die Wiederholung stoppt.
          default: "Benachrichtigungen anhalten"

    custom_section:
      name: Eigene Aktionen / Bedingungen
      icon: mdi:cog
      collapsed: true
      input:
        input_custom_condition:
          name: "‚ùå Bedingungen"
          description: >
            Bedingungen, die erf√ºllt sein m√ºssen.
          default: []
          selector:
            condition:

        input_custom_action_on:
          name: "üé¨ Eigene Aktion bei Eintritt"
          description: >
            Wird ausgef√ºhrt, wenn die Entit√§t den Zielzustand erreicht.
          default: []
          selector:
            action: {}

        input_custom_action_off:
          name: "üé¨ Eigene Aktion bei Verlassen"
          description: >
            Wird ausgef√ºhrt, wenn die Entit√§t den Zielzustand verl√§sst.
          default: []
          selector:
            action: {}

trigger_variables:
  input_entities: !input input_entities

trigger:
  # Gleichheitsvergleiche (einfach)
  - id: "state_on"
    trigger: state
    entity_id: !input input_entities
    to: !input input_entity_states
    for: !input input_entity_state_duration

  - id: "state_off"
    trigger: state
    entity_id: !input input_entities
    not_to: !input input_entity_states

  # Multi-State via Index
  - id: "ms_on"
    trigger: state
    entity_id: !input ms_entities
    for: !input input_entity_state_duration

  - id: "ms_off"
    trigger: state
    entity_id: !input ms_entities

  # Multi-Numeric via Index (State-Trigger; Pr√ºfung im Template + wait_template)
  - id: "num_multi_on"
    trigger: state
    entity_id: !input nm_entities

  - id: "num_multi_off"
    trigger: state
    entity_id: !input nm_entities

  # Periodik
  - id: "period"
    trigger: event
    event_type: esn_event
    event_data:
      automation: "{{ this.entity_id }}"

variables:
  # Inputs / Benachrichtigung
  input_period: !input input_period
  input_notify_devices: !input input_notify_devices
  input_notify_groups: !input input_notify_groups
  input_stop_button_text: !input input_stop_button_text
  input_entity_states: !input input_entity_states
  input_notification_auto_delete: !input input_notification_auto_delete
  input_interruption_level: !input input_interruption_level
  input_ios_sound: !input input_ios_sound
  input_critical_volume: !input input_critical_volume
  input_group_text: !input input_group_text
  input_custom_tag: !input input_custom_tag

  # Actionable inputs
  input_action_timeout: !input input_action_timeout
  a1_enabled: !input input_action1_enabled
  a1_title: !input input_action1_title
  a1_type: !input input_action1_type
  a1_uri: !input input_action1_uri
  a1_destructive: !input input_action1_destructive
  a1_ha_action: !input input_action1_ha_action
  a2_enabled: !input input_action2_enabled
  a2_title: !input input_action2_title
  a2_type: !input input_action2_type
  a2_uri: !input input_action2_uri
  a2_destructive: !input input_action2_destructive
  a2_ha_action: !input input_action2_ha_action
  a3_enabled: !input input_action3_enabled
  a3_title: !input input_action3_title
  a3_type: !input input_action3_type
  a3_uri: !input input_action3_uri
  a3_destructive: !input input_action3_destructive
  a3_ha_action: !input input_action3_ha_action

  # Multi-State Listen
  ms_entities: !input ms_entities
  ms_target_states: !input ms_target_states

  # Multi-Numeric Listen (Operator im Schwellwert)
  nm_entities: !input nm_entities
  nm_thresholds: !input nm_thresholds
  input_numeric_entity_state_duration: !input input_numeric_entity_state_duration

  # Helper
  is_period_trigger: "{{ trigger.id == 'period' }}"
  now_ts: "{{ now() }}"
  is_perodical: "{{ as_datetime(now_ts) != as_datetime(now_ts) + timedelta(**input_period) }}"
  entity: >
    {% if is_period_trigger %}
      {{ trigger.event.data.entity }}
    {% else %}
      {{ trigger.entity_id }}
    {% endif %}
  entity_name: "{{ state_attr(entity, 'friendly_name') }}"

  action_tag: "STOP_{{ this.entity_id }}_{{ entity }}"
  default_tag: "{{ this.entity_id.split('.')[1] + entity.split('.')[1] }}"
  tag: >
    {% set t = (input_custom_tag | string) %}
    {% if t|length > 0 %}
      {{ t }}
    {% else %}
      {{ default_tag }}
    {% endif %}

  # Buttons (inkl. Stopp f√ºr Periodik)
  action_buttons: >
    {% set acts = [] %}
    {% if a1_enabled %}
      {% if a1_type == 'uri' %}
        {% set acts = acts + [ {'action':'URI_1','title':a1_title,'uri':a1_uri,'destructive': a1_destructive} ] %}
      {% else %}
        {% set acts = acts + [ {'action':'ACT_1','title':a1_title,'destructive': a1_destructive} ] %}
      {% endif %}
    {% endif %}
    {% if a2_enabled %}
      {% if a2_type == 'uri' %}
        {% set acts = acts + [ {'action':'URI_2','title':a2_title,'uri':a2_uri,'destructive': a2_destructive} ] %}
      {% else %}
        {% set acts = acts + [ {'action':'ACT_2','title':a2_title,'destructive': a2_destructive} ] %}
      {% endif %}
    {% endif %}
    {% if a3_enabled %}
      {% if a3_type == 'uri' %}
        {% set acts = acts + [ {'action':'URI_3','title':a3_title,'uri':a3_uri,'destructive': a3_destructive} ] %}
      {% else %}
        {% set acts = acts + [ {'action':'ACT_3','title':a3_title,'destructive': a3_destructive} ] %}
      {% endif %}
    {% endif %}
    {% if is_perodical %}
      {% set acts = acts + [ {'action': action_tag, 'title': input_stop_button_text} ] %}
    {% endif %}
    {{ acts }}

  # State-Evaluation
  new_state: >
    {% if is_period_trigger %}
      {{ states(entity) }}
    {% else %}
      {{ trigger.to_state.state }}
    {% endif %}
  old_state: >
    {% if is_period_trigger %}
      {{ trigger.event.data.last_state }}
    {% else %}
      {{ trigger.from_state.state }}
    {% endif %}

  # Benachrichtigungsziele
  notify_devices: "{{ input_notify_devices | map('device_attr', 'name') | list }}"
  notify: >
    {% set result = namespace(r=[]) %}
    {% for device in notify_devices %}
      {% set result.r = result.r + ['notify.mobile_app_' + device | slugify] %}
    {% endfor %}
    {% for group in input_notify_groups %}
      {% set result.r = result.r + ['notify.' + group] %}
    {% endfor %}
    {{ result.r }}

  # Multi-State Mapping
  ms_index: >
    {% set lst = ms_entities | list %}
    {% if entity in lst %}{{ lst.index(entity) }}{% else %}-1{% endif %}
  ms_states_for_entity: >
    {% set states_list = ms_target_states | list %}
    {% if ms_index >= 0 and ms_index < states_list|length %}
      {% set raw = (states_list[ms_index] | string) %}
      {{ (raw | replace(',', '|') | lower).split('|') | map('trim') | list }}
    {% else %}
      {{ [] }}
    {% endif %}

  # Multi-Numeric Mapping: Operator + Wert aus nm_thresholds parsen
  nm_index: >
    {% set lst = nm_entities | list %}
    {% if entity in lst %}{{ lst.index(entity) }}{% else %}-1{% endif %}

  nm_op_for_entity: >
    {% set ths = nm_thresholds | list %}
    {% if nm_index >= 0 and nm_index < ths|length %}
      {% set raw = (ths[nm_index] | string).strip() %}
      {% set first = raw[:1] %}
      {% if first == '<' %}
        {{ 'below' }}
      {% elif first == '>' %}
        {{ 'above' }}
      {% else %}
        {{ 'above' }}  {# Fallback: kein Operator angegeben -> 'above' #}
      {% endif %}
    {% else %}
      {{ 'above' }}
    {% endif %}

  nm_val_for_entity: >
    {% set ths = nm_thresholds | list %}
    {% if nm_index >= 0 and nm_index < ths|length %}
      {% set raw = (ths[nm_index] | string).strip() %}
      {% set valpart = (raw[1:] if raw[:1] in ['<','>'] else raw) %}
      {% set cleaned = valpart.replace(',', '.').strip() %}
      {{ cleaned | float(0) }}
    {% else %}
      {{ 0 }}
    {% endif %}

  # Trigger-Bewertung (inkl. Multi-State und Multi-Numeric)
  create_notifictaion: >
    {{
      trigger.id in ['state_on','period']
      or (
        trigger.id == 'num_multi_on' and (
          (nm_op_for_entity == 'above' and (new_state | float(0)) > (nm_val_for_entity | float(0)))
          or
          (nm_op_for_entity == 'below' and (new_state | float(0)) < (nm_val_for_entity | float(0)))
        )
      )
      or (
        trigger.id == 'ms_on'
        and (new_state | lower) in ms_states_for_entity
      )
    }}

condition:
  - condition: or
    conditions:
      # Auto-L√∂schung wenn NICHT mehr erf√ºllt ODER wenn ein Off-Trigger kommt
      - condition: template
        value_template: >
          {{
            (not create_notifictaion and input_notification_auto_delete)
            or
            (trigger.id in ['state_off','num_multi_off','ms_off'] and input_notification_auto_delete)
          }}
      - condition: and
        conditions:
          - condition: and
            conditions: !input input_custom_condition
          - condition: template
            value_template: "{{ create_notifictaion }}"

action:
  - if:
      - condition: template
        value_template: "{{ create_notifictaion }}"
    then:

      # Nur bei Multi-Numerik: Verweilzeit korrekt pr√ºfen, bevor gesendet wird
      - if:
          - condition: template
            value_template: >
              {{ trigger.id == 'num_multi_on' and
                 ( (input_numeric_entity_state_duration.hours|int > 0)
                   or (input_numeric_entity_state_duration.minutes|int > 0)
                   or (input_numeric_entity_state_duration.seconds|int > 0) ) }}
        then:
          - wait_template: >
              {% set v = states(entity) | float(0) %}
              {% if nm_op_for_entity == 'above' %}
                {{ v > (nm_val_for_entity | float(0)) }}
              {% else %}
                {{ v < (nm_val_for_entity | float(0)) }}
              {% endif %}
            timeout: !input input_numeric_entity_state_duration
            continue_on_timeout: false

      # HA-Frontend-Notification (optional)
      - if:
          - condition: template
            value_template: !input input_ha_notification
        then:
          - action: persistent_notification.create
            data:
              title: !input input_title
              message: !input input_message
              notification_id: "{{ tag }}"

      # Eigene Eintrittsaktion
      - variables:
          custom_action_on: !input input_custom_action_on
      - if:
          - condition: template
            value_template: "{{ custom_action_on != none }}"
        then:
          - choose: []
            default: !input input_custom_action_on

      # Mobile/Gruppen-Benachrichtigung(en)
      - repeat:
          count: "{{ notify | count | int }}"
          sequence:
            - variables:
                index: "{{ repeat.index-1 }}"
                notify_target: "{{ notify[index] }}"
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ input_interruption_level == 'critical' }}"
                  sequence:
                    - action: "{{ notify_target }}"
                      data:
                        title: !input input_title
                        message: !input input_message
                        data:
                          ttl: 0
                          priority: high
                          tag: "{{ tag }}"
                          persistent: !input input_persistent_notification
                          sticky: !input input_persistent_notification
                          group: !input input_group_text
                          push:
                            interruption-level: critical
                            sound:
                              name: !input input_ios_sound
                              critical: 1
                              volume: !input input_critical_volume
                          actions: "{{ action_buttons }}"
              default:
                - action: "{{ notify_target }}"
                  data:
                    title: !input input_title
                    message: !input input_message
                    data:
                      ttl: 0
                      priority: high
                      tag: "{{ tag }}"
                      persistent: !input input_persistent_notification
                      sticky: !input input_persistent_notification
                      group: !input input_group_text
                      push:
                        interruption-level: !input input_interruption_level
                        sound: !input input_ios_sound
                      actions: "{{ action_buttons }}"

      # Periodische Wiederholung
      - if:
          - condition: template
            value_template: "{{ is_perodical }}"
        then:
          - wait_for_trigger:
              - trigger: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "{{ action_tag }}"
            timeout: !input input_period
          - variables:
              latest_state: "{{ states(entity) }}"
              latest_trigger_id: >
                {% if is_period_trigger %}
                  {{ trigger.event.data.trigger_id }}
                {% else %}
                  {{ trigger.id }}
                {% endif %}
              latest_state_condition: >
                {% if latest_trigger_id == 'state_on' %}
                  {{ latest_state in input_entity_states }}
                {% elif latest_trigger_id == 'ms_on' %}
                  {{ (latest_state | lower) in ms_states_for_entity }}
                {% elif latest_trigger_id == 'num_multi_on' %}
                  {{ (latest_state | float(0)) > (nm_val_for_entity | float(0)) if nm_op_for_entity == 'above'
                     else (latest_state | float(0)) < (nm_val_for_entity | float(0)) }}
                {% endif %}
          - if:
              - condition: template
                value_template: "{{ latest_state_condition }}"
              - condition: template
                value_template: "{{ wait.trigger == none }}"
            then:
              - event: esn_event
                event_data:
                  entity: "{{ entity }}"
                  automation: "{{ this.entity_id }}"
                  last_state: "{{ latest_state }}"
                  trigger_id: "{{ latest_trigger_id }}"

      # Actionable: auf Antwort warten und ggf. HA-Aktionen ausf√ºhren
      - wait_for_trigger:
          - trigger: event
            event_type: mobile_app_notification_action
            event_data:
              tag: "{{ tag }}"
        timeout: !input input_action_timeout

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger is not none and wait.trigger.event.data.action in ['ACT_1'] }}"
              - condition: template
                value_template: "{{ a1_enabled and a1_type == 'ha_action' }}"
            sequence: !input input_action1_ha_action
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger is not none and wait.trigger.event.data.action in ['ACT_2'] }}"
              - condition: template
                value_template: "{{ a2_enabled and a2_type == 'ha_action' }}"
            sequence: !input input_action2_ha_action
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger is not none and wait.trigger.event.data.action in ['ACT_3'] }}"
              - condition: template
                value_template: "{{ a3_enabled and a3_type == 'ha_action' }}"
            sequence: !input input_action3_ha_action

    else:
      # Benachrichtigungen l√∂schen
      - action: notify.notify
        data:
          data:
            tag: "{{ tag }}"
            ttl: 0
            priority: high
          message: clear_notification
      - action: persistent_notification.dismiss
        data:
          notification_id: "{{ tag }}"
      - variables:
          custom_action_off: !input input_custom_action_off
      - if:
          - condition: template
            value_template: "{{ custom_action_off != none }}"
        then:
          - choose: []
            default: !input input_custom_action_off

mode: parallel
max: 20
